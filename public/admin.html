<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Funeral Home Services</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>üìä Admin Dashboard</h1>
      <p>Manage and review service arrangement requests</p>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h2 style="color: var(--primary-color); font-size: 1.75rem;">Service Requests</h2>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="refreshData()">
          üîÑ Refresh Data
        </button>
        <button class="btn btn-secondary" onclick="exportToCSV()">
          üì• Export to CSV
        </button>
        <a href="/" class="btn btn-secondary">
          ‚Üê Back to Form
        </a>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <h3>Total Submissions</h3>
        <div class="stat-value" id="totalSubmissions">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
        <h3>Pending Review</h3>
        <div class="stat-value" id="pendingSubmissions">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <h3>Completed</h3>
        <div class="stat-value" id="completedSubmissions">0</div>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="card">
      <div class="search-filter">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="Search by name, email, or phone..." onkeyup="filterTable()">
        </div>
        <select id="statusFilter" class="form-group" style="min-width: 200px;" onchange="filterTable()">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="reviewed">Reviewed</option>
          <option value="completed">Completed</option>
        </select>
      </div>

      <!-- Submissions Table -->
      <div class="table-container">
        <table id="submissionsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Deceased Name</th>
              <th>Contact Name</th>
              <th>Contact Phone</th>
              <th>Contact Email</th>
              <th>Service Type</th>
              <th>Submission Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                Loading submissions...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Submission Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Details will be populated here -->
      </div>
    </div>
  </div>

  <script>
    let allSubmissions = [];
    let filteredSubmissions = [];

    // Load submissions on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadSubmissions();
    });

    // Load all submissions
    async function loadSubmissions() {
      try {
        const response = await fetch('/api/responses');
        const result = await response.json();

        if (result.success) {
          allSubmissions = result.data;
          filteredSubmissions = allSubmissions;
          updateStatistics();
          renderTable();
        } else {
          showError('Failed to load submissions');
        }
      } catch (error) {
        console.error('Error loading submissions:', error);
        showError('Error loading submissions. Please refresh the page.');
      }
    }

    // Update statistics
    function updateStatistics() {
      const total = allSubmissions.length;
      const pending = allSubmissions.filter(s => s.status === 'pending').length;
      const completed = allSubmissions.filter(s => s.status === 'completed').length;

      document.getElementById('totalSubmissions').textContent = total;
      document.getElementById('pendingSubmissions').textContent = pending;
      document.getElementById('completedSubmissions').textContent = completed;
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('tableBody');

      if (filteredSubmissions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-muted);">
              No submissions found
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredSubmissions.map(submission => `
        <tr>
          <td><strong>#${submission.id}</strong></td>
          <td>${submission.deceased_first_name} ${submission.deceased_last_name}</td>
          <td>${submission.contact_first_name} ${submission.contact_last_name}</td>
          <td>${submission.contact_phone}</td>
          <td>${submission.contact_email}</td>
          <td>${formatServiceType(submission.service_type)}</td>
          <td>${formatDate(submission.submission_date)}</td>
          <td>
            <span class="status-badge status-${submission.status}">
              ${submission.status}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-primary" onclick="viewDetails(${submission.id})">
                üëÅÔ∏è View
              </button>
              <select class="btn btn-sm" onchange="updateStatus(${submission.id}, this.value)" style="padding: 0.5rem;">
                <option value="">Change Status</option>
                <option value="pending" ${submission.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="reviewed" ${submission.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                <option value="completed" ${submission.status === 'completed' ? 'selected' : ''}>Completed</option>
              </select>
              <button class="btn btn-sm btn-danger" onclick="deleteSubmission(${submission.id})">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Filter table
    function filterTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      filteredSubmissions = allSubmissions.filter(submission => {
        const matchesSearch = 
          submission.deceased_first_name.toLowerCase().includes(searchTerm) ||
          submission.deceased_last_name.toLowerCase().includes(searchTerm) ||
          submission.contact_first_name.toLowerCase().includes(searchTerm) ||
          submission.contact_last_name.toLowerCase().includes(searchTerm) ||
          submission.contact_email.toLowerCase().includes(searchTerm) ||
          submission.contact_phone.includes(searchTerm);

        const matchesStatus = !statusFilter || submission.status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      renderTable();
    }

    // View submission details
    async function viewDetails(id) {
      try {
        const response = await fetch(`/api/responses/${id}`);
        const result = await response.json();

        if (result.success) {
          const submission = result.data;
          const modalBody = document.getElementById('modalBody');

          modalBody.innerHTML = `
            <div class="detail-grid">
              <div style="grid-column: 1 / -1; background: var(--primary-color); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Submission #${submission.id}</h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Submitted on ${formatDate(submission.submission_date)}</p>
              </div>

              <h3 style="grid-column: 1 / -1; color: var(--primary-color); margin-top: 1rem;">Deceased Information</h3>
              <div class="detail-item">
                <div class="detail-label">Full Name:</div>
                <div class="detail-value">${submission.deceased_first_name} ${submission.deceased_last_name}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Date of Birth:</div>
                <div class="detail-value">${formatDate(submission.deceased_dob)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Date of Death:</div>
                <div class="detail-value">${formatDate(submission.deceased_dod)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">SSN:</div>
                <div class="detail-value">${submission.deceased_ssn || 'Not provided'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Veteran Status:</div>
                <div class="detail-value">${submission.veteran_status || 'Not specified'}</div>
              </div>

              <h3 style="grid-column: 1 / -1; color: var(--primary-color); margin-top: 1rem;">Service Preferences</h3>
              <div class="detail-item">
                <div class="detail-label">Service Type:</div>
                <div class="detail-value">${formatServiceType(submission.service_type)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Service Date:</div>
                <div class="detail-value">${submission.service_date ? formatDate(submission.service_date) : 'Not specified'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Service Time:</div>
                <div class="detail-value">${submission.service_time || 'Not specified'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Service Location:</div>
                <div class="detail-value">${submission.service_location || 'Not specified'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Final Disposition:</div>
                <div class="detail-value">${submission.burial_cremation}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Religious Preference:</div>
                <div class="detail-value">${submission.religious_preference || 'Not specified'}</div>
              </div>

              <h3 style="grid-column: 1 / -1; color: var(--primary-color); margin-top: 1rem;">Contact Information</h3>
              <div class="detail-item">
                <div class="detail-label">Contact Name:</div>
                <div class="detail-value">${submission.contact_first_name} ${submission.contact_last_name}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Phone:</div>
                <div class="detail-value"><a href="tel:${submission.contact_phone}">${submission.contact_phone}</a></div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email:</div>
                <div class="detail-value"><a href="mailto:${submission.contact_email}">${submission.contact_email}</a></div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Address:</div>
                <div class="detail-value">
                  ${submission.contact_address || 'Not provided'}<br>
                  ${submission.contact_city ? submission.contact_city + ', ' : ''}${submission.contact_state || ''} ${submission.contact_zip || ''}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Relationship:</div>
                <div class="detail-value">${submission.contact_relationship}</div>
              </div>

              ${submission.obituary_text ? `
                <h3 style="grid-column: 1 / -1; color: var(--primary-color); margin-top: 1rem;">Obituary</h3>
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <div class="detail-value" style="white-space: pre-wrap;">${submission.obituary_text}</div>
                </div>
              ` : ''}

              ${submission.additional_notes ? `
                <h3 style="grid-column: 1 / -1; color: var(--primary-color); margin-top: 1rem;">Additional Notes</h3>
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <div class="detail-value" style="white-space: pre-wrap;">${submission.additional_notes}</div>
                </div>
              ` : ''}

              <div style="grid-column: 1 / -1; margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="printDetails()">üñ®Ô∏è Print</button>
                <button class="btn btn-primary" onclick="closeModal()">Close</button>
              </div>
            </div>
          `;

          document.getElementById('detailModal').classList.add('active');
        }
      } catch (error) {
        console.error('Error loading details:', error);
        alert('Error loading submission details');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    // Update submission status
    async function updateStatus(id, newStatus) {
      if (!newStatus) return;

      try {
        const response = await fetch(`/api/responses/${id}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus }),
        });

        const result = await response.json();

        if (result.success) {
          await loadSubmissions();
          alert('Status updated successfully');
        } else {
          alert('Failed to update status');
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status');
      }
    }

    // Delete submission
    async function deleteSubmission(id) {
      if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/responses/${id}`, {
          method: 'DELETE',
        });

        const result = await response.json();

        if (result.success) {
          await loadSubmissions();
          alert('Submission deleted successfully');
        } else {
          alert('Failed to delete submission');
        }
      } catch (error) {
        console.error('Error deleting submission:', error);
        alert('Error deleting submission');
      }
    }

    // Refresh data
    function refreshData() {
      loadSubmissions();
    }

    // Export to CSV
    function exportToCSV() {
      if (allSubmissions.length === 0) {
        alert('No data to export');
        return;
      }

      const headers = [
        'ID', 'Deceased First Name', 'Deceased Last Name', 'Date of Birth', 'Date of Death', 'SSN',
        'Service Type', 'Service Date', 'Service Time', 'Service Location', 'Burial/Cremation',
        'Contact First Name', 'Contact Last Name', 'Contact Phone', 'Contact Email',
        'Contact Address', 'Contact City', 'Contact State', 'Contact ZIP', 'Relationship',
        'Veteran Status', 'Religious Preference', 'Status', 'Submission Date'
      ];

      const rows = allSubmissions.map(s => [
        s.id, s.deceased_first_name, s.deceased_last_name, s.deceased_dob, s.deceased_dod, s.deceased_ssn || '',
        s.service_type, s.service_date || '', s.service_time || '', s.service_location || '', s.burial_cremation,
        s.contact_first_name, s.contact_last_name, s.contact_phone, s.contact_email,
        s.contact_address || '', s.contact_city || '', s.contact_state || '', s.contact_zip || '', s.contact_relationship,
        s.veteran_status || '', s.religious_preference || '', s.status, s.submission_date
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `funeral-home-submissions-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Print details
    function printDetails() {
      window.print();
    }

    // Utility functions
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function formatServiceType(type) {
      const types = {
        'traditional': 'Traditional Funeral Service',
        'memorial': 'Memorial Service',
        'graveside': 'Graveside Service',
        'celebration': 'Celebration of Life',
        'direct': 'Direct Burial/Cremation',
        'viewing': 'Viewing/Visitation Only'
      };
      return types[type] || type;
    }

    function showError(message) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 3rem; color: var(--error-color);">
            ${message}
          </td>
        </tr>
      `;
    }

    // Close modal when clicking outside
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
